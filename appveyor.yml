image: Visual Studio 2019
configuration: Release
platform: Any CPU
skip_tags: true

services:
  - mssql2017

install:
  - ps: $exePath = "$env:USERPROFILE\SSCERuntime-ENU.exe"
  - ps: (New-Object Net.WebClient).DownloadFile('https://download.microsoft.com/download/E/C/1/EC1B2340-67A0-4B87-85F0-74D987A27160/SSCERuntime-ENU.exe', $exePath)
  
  - ps: Write-Host "Installing..."
  - ps: cmd /c start /wait $exePath /Q
  - ps: Write-Host "SQL Server Compact installed" -foregroundcolor Green
  
  - ps: $zipPath = "$env:TEMP\SSCERuntime-ENU.exe"
  - ps: Write-Host "Doanloading..."
  - ps: (New-Object Net.WebClient).DownloadFile('https://download.microsoft.com/download/E/C/1/EC1B2340-67A0-4B87-85F0-74D987A27160/SSCERuntime-ENU.exe', $zipPath )
  
  - ps: $destPath = "$env:TEMP\SSCERuntime"
  - ps: Write-Host "Unpacking..."
  - ps: 7z x $zipPath -o"$destPath" | Out-Null
  
  - ps: Write-Host "Installing..."
  - ps: # according to install.txt It is mandatory to install both the 32-bit and the 64-bit 
  - ps: # version of SQL Server Compact MSI files on a 64-bit Computer
  - ps: cmd /c start /wait $destPath\SSCERuntime_x86-ENU.msi /quiet /norestart
  - ps: cmd /c start /wait $destPath\SSCERuntime_x64-ENU.msi /quiet /norestart
  
  - ps: Write-Host "SQL Server Compact installed" -foregroundcolor Green
  - ps: $env:version_file_path = ".\version.props"
  - ps: gitversion /output buildserver
  - ps: $env:major_version = (Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/MajorVersion" | Select-Object -ExpandProperty Node).InnerText
  - ps: $env:minor_version = (Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/MinorVersion" | Select-Object -ExpandProperty Node).InnerText
  - ps: $env:release_version = [string]([int]((Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/ReleaseVersion" | Select-Object -ExpandProperty Node).InnerText) + 1)
  - ps: $env:revision = $env:GitVersion_CommitsSinceVersionSource
  - ps: Update-AppveyorBuild -Version "$env:major_version.$env:minor_version.$env:release_version.$env:revision.$env:APPVEYOR_BUILD_NUMBER"
  - ps: $xReleaseVersion = Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/ReleaseVersion"
  - ps: $xReleaseVersion.Node.InnerText = $env:release_version
  - ps: $xReleaseVersion.Node.OwnerDocument.Save($xReleaseVersion.Path)
  - ps: $xRevision = Select-Xml -Path $env:version_file_path -XPath "/Project/PropertyGroup/Revision"
  - ps: $xRevision.Node.InnerText = $env:revision
  - ps: $xRevision.Node.OwnerDocument.Save($xRevision.Path)

dotnet_csproj:
  patch: false

before_build:
- cmd: dotnet restore "source\Data.sln"

build:
  project: source\Data.sln
  parallel: true
  verbosity: minimal

after_build:
  - cmd: scripts\CREATE_Northwind.bat

after_test:
  - cmd: scripts\DROP_Northwind.bat

artifacts:
- path: 'bin\Release\EnterpriseLibrary.Data.*.nupkg'
  name: 'EnterpriseLibrary.Data'

on_success:
  - ps: git config --global credential.helper store
  - ps: Add-Content "$HOME\.git-credentials" "https://$($env:github_access_token):x-oauth-basic@github.com`n"
  - ps: git config --global user.email "$env:github_email"
  - ps: git config --global user.name "$env:github_name"
  - git pull
  - git commit -m "Revision update by AppVeyor [ci skip]" -- version.props
  - git push
